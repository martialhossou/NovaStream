!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NovaStream • Tout-en-un (Front + Auth + Favoris)</title>
  <meta name="description" content="NovaStream — streaming façon Netflix : lecture libre (YouTube), Auth e-mail+mot de passe, favoris, pubs Adsterra, connectée à Supabase." />
  <meta name="theme-color" content="#0A0B10" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0A0B10; --panel:#0E1118; --ink:#E9EFFA; --muted:#9AA3B8; --line:#202538;
           --accent:#E50914; --accent2:#FF6933; --card:#0f1220; --radius:14px; --maxw:1240px; --shadow:0 20px 60px rgba(0,0,0,.45);}
    *{box-sizing:border-box} html{scroll-behavior:smooth}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,sans-serif;line-height:1.65}
    a{color:inherit;text-decoration:none}
    /* Header */
    header{position:sticky;top:0;z-index:60;background:#0B0D14;border-bottom:1px solid var(--line)}
    .nav{max-width:var(--maxw);margin:auto;display:flex;align-items:center;gap:14px;padding:12px 18px}
    .brand{display:flex;align-items:center;gap:10px;margin-right:auto}
    .mark{width:18px;height:18px;border-radius:6px;background:conic-gradient(from 200deg,#231b1b,var(--accent) 20%,#231b1b 60%,var(--accent) 80%,#231b1b)}
    .logo{font-weight:900;letter-spacing:.35px}
    .search{flex:1;display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:#0f1320;border-radius:10px;padding:8px 10px}
    .search input{flex:1;background:transparent;border:0;outline:0;color:var(--ink)}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--ink);border-radius:10px;padding:.55rem .85rem;font-weight:800;cursor:pointer}
    .btn.primary{border:0;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#1b0c0b}
    .userbox{display:flex;align-items:center;gap:8px}
    .avatar{width:28px;height:28px;border-radius:999px;background:#1a2033;border:1px solid #2a3246;display:inline-flex;align-items:center;justify-content:center;font-weight:900}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:#0E1118;border:1px solid var(--line);border-radius:12px;min-width:220px;box-shadow:var(--shadow);display:none}
    .menu a,.menu button{display:block;width:100%;text-align:left;padding:.6rem .8rem;border:0;background:transparent;color:#d9e2f0;cursor:pointer}
    .menu a:hover,.menu button:hover{background:#12172a}
    .dropdown.open .menu{display:block}
    /* Ads */
    .ad-header-wrap{background:#0B0D14;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
    .ad-header{max-width:var(--maxw);margin:auto;padding:8px 18px;display:flex;justify-content:center;align-items:center;min-height:90px}
    @media (max-width:680px){ .ad-header{min-height:60px} }
    .ad-in{border:1px dashed #2c3550;background:#0c101b;border-radius:12px;min-height:280px;display:flex;align-items:center;justify-content:center;margin:14px 0}
    @media (max-width:680px){ .ad-in{min-height:250px} }
    /* Hero */
    .hero{position:relative;border-bottom:1px solid var(--line);
      background: radial-gradient(900px 600px at -10% -10%, rgba(229,9,20,.14), transparent 60%),
                 radial-gradient(800px 500px at 120% -20%, rgba(255,105,51,.10), transparent 60%);}
    .hero .wrap{max-width:var(--maxw);margin:auto;display:grid;grid-template-columns:1.1fr .9fr;gap:28px;align-items:center;padding:44px 18px}
    h1{font-weight:900;font-size:clamp(28px,5vw,56px);line-height:1.06;margin:0 0 10px}
    .lead{color:var(--muted);max-width:65ch;margin:0 0 10px}
    .hero-visual{border-radius:18px;overflow:hidden;background:#121723;box-shadow:var(--shadow)}
    .hero-visual img{width:100%;height:100%;object-fit:cover;aspect-ratio:16/9}
    /* Sections & cards */
    main{max-width:var(--maxw);margin:auto;padding:0 18px}
    section{padding:26px 0} section h2{margin:0 0 10px;font-size:22px}
    .rail{display:grid;grid-auto-flow:column;grid-auto-columns:clamp(160px,18vw,220px);gap:12px;overflow:auto;padding-bottom:4px;scroll-snap-type:x mandatory}
    .rail::-webkit-scrollbar{height:8px} .rail::-webkit-scrollbar-thumb{background:#1c2233;border-radius:999px}
    .card{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:var(--card);scroll-snap-align:start}
    .poster{width:100%;aspect-ratio:2/3;object-fit:cover;background:#0c0f18}
    .grad{position:absolute;inset:auto 0 0 0;height:50%;background:linear-gradient(180deg,transparent,rgba(0,0,0,.75))}
    .meta{position:absolute;left:0;bottom:0;padding:8px 10px;display:flex;align-items:center;gap:8px}
    .chip{font-size:12px;color:#cbd5e1;border:1px solid #273049;background:#121829;padding:.15rem .45rem;border-radius:999px}
    .playbar{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.18);opacity:0;transition:.25s}
    .card:hover .playbar{opacity:1}
    .fav{position:absolute;top:8px;right:8px;background:#151a27;border:1px solid #2a3246;border-radius:10px;color:#cbd5e1;font-size:12px;padding:.25rem .5rem;cursor:pointer}
    /* Grid tweak */
    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    @media (max-width:1200px){.grid{grid-template-columns:repeat(5,1fr)}}
    @media (max-width:1000px){.grid{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:540px){.grid{grid-template-columns:repeat(2,1fr)}}
    /* Modal (player & auth & legal) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:.25s;z-index:80}
    .modal.show{opacity:1;visibility:visible}
    .modal-box{width:min(94vw,980px);aspect-ratio:16/9;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#000;box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .modal-top{position:absolute;top:12px;right:12px;display:flex;gap:8px}
    .modal-btn{background:#1b2132;border:1px solid #2a3246;color:#e5edff;border-radius:10px;padding:.45rem .7rem;cursor:pointer}
    .modal-btn.close{background:var(--accent);border:0;color:#1b0c0b}
    .sheet{width:min(92vw,520px);border-radius:14px;background:#0F121A;border:1px solid var(--line);box-shadow:var(--shadow);padding:18px}
    .sheet h3{margin:0 0 8px}
    .sheet .row{display:flex;gap:8px;flex-wrap:wrap}
    .input{width:100%;border:1px solid #2a3246;background:#111627;color:#e9effa;border-radius:10px;padding:.6rem .75rem}
    .help{font-size:12px;color:#9AA3B8}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    footer{margin:36px 0 24px;color:#aeb6cb;text-align:center}
    footer a{color:#ffb199}
    .muted{color:#9AA3B8}
  </style>
</head>
<body>
    <!-- === HEADER + NAVIGATION === -->
  <header>
    <div class="nav">
      <div class="brand"><span class="mark"></span><span class="logo">NovaStream</span></div>
      <div class="search"><input id="q" type="search" placeholder="Rechercher un film, un genre…" /></div>
      <div class="userbox" id="userBox">
        <button class="btn" id="lang">FR / EN</button>
        <button class="btn" id="btnLogin">Se connecter</button>
        <button class="btn primary" id="btnSignup">Créer un compte</button>
      </div>
      <div class="userbox" id="userMenu" style="display:none">
        <div class="dropdown" id="dd">
          <button class="btn"><span class="avatar" id="av">P1</span> Mon profil</button>
          <div class="menu" id="menu">
            <button id="btnFavorites">Mes favoris</button>
            <button id="btnProfiles">Gérer les profils</button>
            <button id="btnLogout">Se déconnecter</button>
          </div>
        </div>
      </div>
    </div>
    <div class="ad-header-wrap">
      <div class="ad-header">
        <!-- Adsterra Banner Header -->
        <div style="font-size:12px;color:#aeb6cb">Espace pub (Header)</div>
      </div>
    </div>
  </header>

  <!-- === HERO === -->
  <section class="hero">
    <div class="wrap">
      <div>
        <h1>Votre cinéma, sans créer de compte pour regarder.</h1>
        <p class="lead">Compte requis seulement pour Favoris, Profils et Reprendre.</p>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn primary" onclick="document.getElementById('rail-trending').scrollIntoView({behavior:'smooth'})">Voir les tendances</button>
          <button class="btn" onclick="document.getElementById('grid').scrollIntoView({behavior:'smooth'})">Explorer</button>
        </div>
      </div>
      <div class="hero-visual">
        <img src="https://images.unsplash.com/photo-1517602302552-471fe67acf66?q=80&w=1600" alt="Hero">
      </div>
    </div>
  </section>

  <!-- === SECTIONS === -->
  <main>
    <section><h2>Tendances</h2><div class="rail" id="rail-trending"></div></section>
    <section><h2>Films</h2><div class="rail" id="rail-films"></div></section>
    <section><h2>Séries</h2><div class="rail" id="rail-series"></div></section>
    <section><h2>Explorer</h2><div class="grid" id="grid"></div>
      <div class="ad-in">Espace pub (in-content)</div>
    </section>
  </main>

  <!-- === FOOTER === -->
  <footer>
    <div>© <span id="year"></span> NovaStream — Lecture via lecteur YouTube officiel.</div>
    <div><a href="#" id="lnkCGU">CGU</a> · <a href="#" id="lnkRetrait">Retrait</a> · <a href="#" id="lnkMentions">Mentions</a></div>
  </footer>

  <!-- === MODALES === -->
  <!-- Player -->
  <div class="modal" id="modalPlayer">
    <div class="modal-box">
      <div class="modal-top">
        <button class="modal-btn close" id="closePlayer">Fermer ✕</button>
      </div>
      <div id="mountPlayer"></div>
    </div>
  </div>

  <!-- Auth -->
  <div class="modal" id="modalAuth">
    <div class="sheet">
      <h3 id="authTitle">Se connecter</h3>
      <div class="row">
        <input class="input" id="authEmail" type="email" placeholder="Email" />
        <input class="input" id="authPass" type="password" placeholder="Mot de passe" />
        <div class="help" id="authHelp">Pas de mail de validation. Mot de passe oublié disponible.</div>
      </div>
      <div class="actions">
        <button class="btn" id="authSwitch">Créer un compte</button>
        <button class="btn primary" id="authSubmit">Valider</button>
      </div>
      <div class="help"><a href="#" id="authReset">Mot de passe oublié ?</a></div>
    </div>
  </div>

  <!-- Soft-wall -->
  <div class="modal" id="modalWall">
    <div class="sheet">
      <h3>Crée un compte pour enregistrer tes favoris</h3>
      <p class="muted">Tu pourras aussi reprendre ta lecture sur tous tes appareils.</p>
      <div class="actions">
        <button class="btn" id="wallLater">Plus tard</button>
        <button class="btn primary" id="wallGo">Se connecter / Créer un compte</button>
      </div>
    </div>
  </div>

  <!-- Legal -->
  <div class="modal" id="modalLegal">
    <div class="sheet">
      <h3 id="legalTitle">Document</h3>
      <div class="help" id="legalBody" style="max-height:60vh;overflow:auto">
        <p><strong>CGU :</strong> NovaStream référence des vidéos YouTube légales. Aucune vidéo n'est hébergée ici.</p>
        <p><strong>Retrait :</strong> Indiquez l’URL, la preuve de droits et vos coordonnées. Nous dépublierons après vérification.</p>
        <p><strong>Mentions :</strong> Contact : contact@exemple.com.</p>
      </div>
      <div class="actions"><button class="btn primary" id="legalClose">Fermer</button></div>
    </div>
  </div>
    <!-- === SCRIPT SUPABASE === -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // === CONFIG SUPABASE (à remplacer) ===
    const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ===== DOM helpers ===== */
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const rails = { trending: $('#rail-trending'), films: $('#rail-films'), series: $('#rail-series') };
    const grid = $('#grid'); const q = $('#q');
    $('#year').textContent = new Date().getFullYear();

    /* ===== Player modal ===== */
    const mPlayer = $('#modalPlayer'), mountPlayer = $('#mountPlayer');
    $('#closePlayer').addEventListener('click', ()=>{mPlayer.classList.remove('show');mountPlayer.innerHTML='';});
    function openPlayer(videoId,title){
      mPlayer.classList.add('show');
      mountPlayer.innerHTML=`<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1" title="${title}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    }

    /* ===== Auth modal ===== */
    const mAuth=$('#modalAuth'), authTitle=$('#authTitle'), authEmail=$('#authEmail'), authPass=$('#authPass');
    let authMode='login';
    $('#btnLogin').addEventListener('click',()=>openAuth('login'));
    $('#btnSignup').addEventListener('click',()=>openAuth('signup'));
    $('#authSwitch').addEventListener('click',()=>openAuth(authMode==='login'?'signup':'login'));
    $('#authReset').addEventListener('click',async e=>{
      e.preventDefault();
      const email=authEmail.value.trim(); if(!email) return alert("Entrez votre email");
      const {error}=await supabase.auth.resetPasswordForEmail(email,{redirectTo:window.location.href});
      if(error) alert(error.message); else alert("Email de réinitialisation envoyé");
    });
    function openAuth(mode){authMode=mode;authTitle.textContent=mode==='login'?'Se connecter':'Créer un compte';mAuth.classList.add('show');}
    function closeAuth(){mAuth.classList.remove('show');}

    $('#authSubmit').addEventListener('click',async()=>{
      const email=authEmail.value.trim(),password=authPass.value;
      if(!email||!password) return alert("Email et mot de passe requis");
      if(authMode==='signup'){const {error}=await supabase.auth.signUp({email,password});if(error)return alert(error.message);}
      else {const {error}=await supabase.auth.signInWithPassword({email,password});if(error)return alert(error.message);}
      const {data:{session}}=await supabase.auth.getSession();
      if(session){await ensureDefaultProfile();$('#userBox').style.display='none';$('#userMenu').style.display='flex';closeAuth();}
    });

    $('#btnLogout').addEventListener('click',async()=>{
      await supabase.auth.signOut();
      $('#userMenu').style.display='none';$('#userBox').style.display='flex';
      localStorage.removeItem('NS_PROFILE_ID');
    });

    async function ensureDefaultProfile(){
      try{await supabase.rpc('fn_init_account');}catch{}
      const {data:profs}=await supabase.from('profiles').select('id,name').limit(1);
      if(!profs||profs.length===0){await supabase.rpc('fn_create_profile',{profile_name:'Profil 1'});}
      const {data:profs2}=await supabase.from('profiles').select('id,name').limit(1);
      if(profs2&&profs2[0]){localStorage.setItem('NS_PROFILE_ID',profs2[0].id);$('#av').textContent=(profs2[0].name||'P1').slice(0,2).toUpperCase();}
    }
    (async()=>{const {data:{session}}=await supabase.auth.getSession();if(session){$('#userBox').style.display='none';$('#userMenu').style.display='flex';await ensureDefaultProfile();}})();

    /* ===== Legal modal ===== */
    const mLegal=$('#modalLegal');
    $('#lnkCGU').addEventListener('click',e=>{e.preventDefault();openLegal('CGU','<p>Utilisation autorisée via YouTube.</p>');});
    $('#lnkRetrait').addEventListener('click',e=>{e.preventDefault();openLegal('Retrait','<p>Contact: contact@exemple.com.</p>');});
    $('#lnkMentions').addEventListener('click',e=>{e.preventDefault();openLegal('Mentions','<p>Responsable: Vous-même.</p>');});
    $('#legalClose').addEventListener('click',()=>mLegal.classList.remove('show'));
    function openLegal(title,html){$('#legalTitle').textContent=title;$('#legalBody').innerHTML=html;mLegal.classList.add('show');}

    /* ===== Soft-wall ===== */
    $('#wallLater').addEventListener('click',()=>$('#modalWall').classList.remove('show'));
    $('#wallGo').addEventListener('click',()=>{ $('#modalWall').classList.remove('show'); openAuth('login'); });

    /* ===== RENDERING ===== */
    function card(item){
      const poster=item.thumbnail_url||`https://img.youtube.com/vi/${item.youtube_id}/hqdefault.jpg`;
      const g=item.genres?.[0]||'—';
      return `<article class="card" data-title="${(item.title||'').toLowerCase()}">
        <img class="poster" src="${poster}" alt="${item.title}">
        <div class="grad"></div>
        <div class="meta"><span class="chip">${g}</span><span class="chip">${item.year||''}</span></div>
        <button class="fav" data-fav="${item.id}">+ Favori</button>
        <div class="playbar"><button class="btn primary" data-play="${item.youtube_id}" data-title="${item.title}">▶ Lire</button></div>
      </article>`;
    }
    async function fetchVideos(where){let qv=supabase.from('videos').select('*').limit(30);if(where)qv=where(qv);const {data}=await qv;return data||[];}
    async function render(){
      const [tr,films,series,all]=await Promise.all([
        fetchVideos(),fetchVideos(q=>q.eq('type','Film')),fetchVideos(q=>q.eq('type','Série')),fetchVideos()
      ]);
      $('#rail-trending').innerHTML=tr.map(card).join('');
      $('#rail-films').innerHTML=films.map(card).join('');
      $('#rail-series').innerHTML=series.map(card).join('');
      $('#grid').innerHTML=all.map(card).join('');
    }
    render();

    /* ===== Search ===== */
    q.addEventListener('input',()=>{clearTimeout(q._t);q._t=setTimeout(()=>{const term=q.value.toLowerCase();$$('.card').forEach(el=>{el.style.display=!term||el.dataset.title.includes(term)?'':'none';});},120)});

    /* ===== Events (Play + Fav) ===== */
    document.body.addEventListener('click',async e=>{
      const p=e.target.closest('[data-play]'); if(p){openPlayer(p.dataset.play,p.dataset.title);return;}
      const fav=e.target.closest('[data-fav]'); if(fav){
        const {data:{session}}=await supabase.auth.getSession();
        if(!session){$('#modalWall').classList.add('show');return;}
        const profileId=localStorage.getItem('NS_PROFILE_ID'); if(!profileId)return alert("Profil introuvable");
        const videoId=fav.dataset.fav;
        const {error}=await supabase.from('favorites').insert({profile_id:profileId,video_id:videoId});
        if(error){if(error.code==='23505')alert("Déjà favori"); else alert(error.message);return;}
        fav.textContent='✓ Favori';
      }
    });
  </script>
</body>
</html>
