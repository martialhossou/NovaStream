<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NovaStream — Streaming</title>
  <meta name="theme-color" content="#0A0B10"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0A0B10;--panel:#0E1118;--ink:#E9EFFA;--muted:#A5AEC6;--line:#202538;--accent:#E50914;--accent2:#FF6933;--radius:14px;--maxw:1100px}
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;line-height:1.6}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    button{cursor:pointer}

    /* Header + nav */
    header{position:sticky;top:0;z-index:10;background:#0B0D14;border-bottom:1px solid var(--line)}
    .nav{max-width:var(--maxw);margin:auto;padding:10px 14px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;position:relative;z-index:9999}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .mark{width:18px;height:18px;border-radius:6px;background:conic-gradient(from 200deg,#231b1b,var(--accent) 25%,#231b1b 60%,var(--accent) 85%)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-self:end}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.55rem .85rem;border-radius:10px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:#fff;font-weight:800}
    .btn.primary{border:0;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#1b0c0b}
    .hidden{display:none !important}
    .search{grid-column:1/-1;display:flex;gap:8px;border:1px solid var(--line);background:#101425;border-radius:10px;padding:8px}
    .search input{flex:1;background:transparent;border:0;color:var(--ink);outline:0}

    /* Ad header (kept below nav, no overlap) */
    .ad-header{border-top:1px solid var(--line);border-bottom:1px solid var(--line);display:flex;justify-content:center;align-items:center;min-height:64px;position:relative;z-index:5;overflow:hidden}
    .ad-header iframe,.ad-header ins,.ad-header div{display:block;max-width:100%;height:auto}

    /* Hero */
    .hero{background:radial-gradient(900px 600px at -10% -10%,rgba(229,9,20,.14),transparent 60%),radial-gradient(800px 500px at 120% -20%,rgba(255,105,51,.1),transparent 60%);border-bottom:1px solid var(--line)}
    .hero .wrap{max-width:var(--maxw);margin:auto;padding:24px 14px;display:grid;gap:12px}
    .hero h1{margin:0;font-size:clamp(22px,6vw,36px);line-height:1.1}
    .lead{color:var(--muted)}

    /* Main */
    main{max-width:var(--maxw);margin:auto;padding:0 14px}
    section{padding:16px 0}
    h2{margin:0 0 8px;font-size:18px}

    .rail{display:grid;grid-auto-flow:column;grid-auto-columns:44vw;gap:10px;overflow-x:auto;padding-bottom:4px;scroll-snap-type:x mandatory}
    @media(min-width:640px){.rail{grid-auto-columns:200px}}
    .card{position:relative;border:1px solid var(--line);background:#0f1220;border-radius:12px;overflow:hidden;scroll-snap-align:start}
    .poster{aspect-ratio:2/3;object-fit:cover;width:100%;background:#0c0f18}
    .meta{position:absolute;left:0;bottom:0;padding:8px;display:flex;gap:6px}
    .chip{font-size:11px;border:1px solid #273049;background:#121829;border-radius:999px;padding:.15rem .45rem;color:#cbd5e1}
    .fav{position:absolute;top:8px;right:8px;background:#151a27;border:1px solid #2a3246;border-radius:10px;color:#cbd5e1;font-size:12px;padding:.25rem .5rem}
    .playbar{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.18);opacity:0;transition:.25s}
    .card:hover .playbar{opacity:1}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(4,1fr)}}
    @media(min-width:960px){.grid{grid-template-columns:repeat(5,1fr)}}

    /* Footer */
    footer{padding:24px 14px;border-top:1px solid var(--line);text-align:center;color:#b8c1d6}

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:.2s;z-index:60}
    .modal.show{opacity:1;visibility:visible}
    .sheet{width:min(94vw,520px);border-radius:14px;background:#0F121A;border:1px solid var(--line);padding:14px;max-height:92vh;overflow:auto}
    .sheet h3{margin:0 0 8px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .input,select,textarea{width:100%;border:1px solid #2a3246;background:#111627;color:#e9effa;border-radius:10px;padding:.6rem .75rem}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    /* Player */
    .box{width:min(94vw,980px);aspect-ratio:16/9;border-radius:14px;background:#000;border:1px solid var(--line);overflow:hidden}
    .top-right{position:absolute;top:10px;right:10px;display:flex;gap:8px}

    /* Dashboard */
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:.45rem .75rem;border:1px solid var(--line);border-radius:999px}
    .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));border:0;color:#1b0c0b}
    .dash{border:1px solid var(--line);background:#0E1118;border-radius:14px;padding:14px;margin-top:10px}
    .muted{color:#a5aec6}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <a class="brand" href="/"><span class="mark"></span><span>NovaStream</span></a>
      <div class="actions">
        <button class="btn" id="btnLogin">Se connecter</button>
        <button class="btn" id="btnSignup">Créer un compte</button>
        <a class="btn hidden" id="btnDashboard" href="#dashboard">Tableau de bord</a>
        <button class="btn hidden" id="btnLogout">Se déconnecter</button>
      </div>
      <div class="search">
        <input id="q" placeholder="Rechercher un titre, un genre…"/>
      </div>
    </div>
    <div class="ad-header">
      <script type="text/javascript">
  atOptions = {
    'key' : '775e4be40566091a77561b2c52bd6e4f',
    'format' : 'iframe',
    'height' : 60,
    'width' : 468,
    'params' : {}
  };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/775e4be40566091a77561b2c52bd6e4f/invoke.js"></script>
    </div>
  </header>

  <section class="hero">
    <div class="wrap">
      <h1>Votre cinéma, sans quitter le canapé.</h1>
      <p class="lead">Films & séries YouTube (liens officiels). Ajoute à tes favoris, reprends là où tu t’es arrêté.</p>
    </div>
  </section>

  <main>
    <section id="trending">
      <h2>Tendances</h2>
      <div class="rail" id="rail-trending"></div>
    </section>

    <section id="explore">
      <h2>Explorer</h2>
      <div class="grid" id="grid"></div>
      <div style="margin-top:10px;border-top:1px solid var(--line);padding-top:10px;text-align:center">
        <script type="text/javascript">
  atOptions = {
    'key' : '775e4be40566091a77561b2c52bd6e4f',
    'format' : 'iframe',
    'height' : 60,
    'width' : 468,
    'params' : {}
  };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/775e4be40566091a77561b2c52bd6e4f/invoke.js"></script>
      </div>
    </section>

    <section id="dashboard" class="dash hidden">
      <h2>Tableau de bord</h2>
      <div class="tabs" style="margin:8px 0 10px">
        <button class="tab active" data-tab="fav">Favoris</button>
        <button class="tab" data-tab="profiles">Profils</button>
        <button class="tab" data-tab="account">Compte</button>
      </div>

      <!-- Favoris -->
      <div id="tab-fav">
        <div id="favGrid" class="grid"></div>
        <div id="favEmpty" class="muted" style="margin-top:8px">Aucun favori pour l’instant.</div>
      </div>

      <!-- Profils -->
      <div id="tab-profiles" class="hidden">
        <div class="row">
          <input id="newProfileName" class="input" placeholder="Nom du profil"/>
          <button class="btn" id="btnCreateProfile">Créer</button>
        </div>
        <div id="profilesList" style="margin-top:10px"></div>
      </div>

      <!-- Compte -->
      <div id="tab-account" class="hidden">
        <div class="row">
          <div class="sheet" style="flex:1">
            <h3>Changer mon email</h3>
            <input id="newEmail" class="input" placeholder="nouvel.email@exemple.com"/>
            <div class="modal-actions">
              <button class="btn" id="btnChangeEmail">Mettre à jour</button>
            </div>
            <div class="muted">Un email de confirmation peut être envoyé selon ta config Supabase.</div>
          </div>
          <div class="sheet" style="flex:1">
            <h3>Changer mon mot de passe</h3>
            <input id="newPass" type="password" class="input" placeholder="Nouveau mot de passe"/>
            <input id="newPass2" type="password" class="input" placeholder="Confirme le mot de passe"/>
            <div class="modal-actions">
              <button class="btn" id="btnChangePass">Mettre à jour</button>
            </div>
            <div class="muted">Tu seras peut-être déconnecté après la mise à jour.</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    © <span id="year"></span> NovaStream — Démo. Catalogue basé sur des liens YouTube publics.
  </footer>

  <!-- Auth Modal -->
  <div class="modal" id="authModal">
    <div class="sheet">
      <h3 id="authTitle">Connexion</h3>
      <div class="row">
        <input id="authEmail" class="input" placeholder="email@exemple.com"/>
        <input id="authPass" type="password" class="input" placeholder="Mot de passe"/>
      </div>
      <div class="modal-actions">
        <button class="btn" id="authClose">Fermer</button>
        <button class="btn" id="authForgot">Mot de passe oublié ?</button>
        <button class="btn primary" id="authSubmit">Valider</button>
      </div>
      <div id="authErr" class="muted" style="color:#ffb3b3;margin-top:6px"></div>
    </div>
  </div>

  <!-- Player Modal -->
  <div class="modal" id="playerModal">
    <div class="box" id="playerBox"></div>
    <div class="top-right">
      <button class="btn" id="playerClose">Fermer ✕</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // Tes clés (gardées telles que fournies)
    const SUPABASE_URL = "https://flbswnzfutxcudcgbrjp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsYnN3bnpmdXR4Y3VkY2dicmpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyOTEwMDcsImV4cCI6MjA3MTg2NzAwN30.L7ZjKIzoyFdbRYuTlXXBD0-NgCPc3poWgEws1ibqUAc";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
    const state={ session:null, activeProfile:null };

    // UI helpers
    function show(el,yes=true){ el.classList.toggle('hidden',!yes); }
    function chip(txt){ const s=document.createElement('span'); s.className='chip'; s.textContent=txt; return s; }
    function card(v){
      const a=document.createElement('article'); a.className='card'; a.dataset.id=v.id;
      const img=document.createElement('img'); img.className='poster'; img.alt=v.title; img.src=v.thumbnail_url||`https://i.ytimg.com/vi/${v.youtube_id}/hqdefault.jpg`; a.appendChild(img);
      const meta=document.createElement('div'); meta.className='meta';
      (v.genres||[]).slice(0,2).forEach(g=>meta.appendChild(chip(g))); a.appendChild(meta);
      const fav=document.createElement('button'); fav.className='fav'; fav.textContent='☆ Favori'; fav.addEventListener('click',(e)=>toggleFav(v,e)); a.appendChild(fav);
      const play=document.createElement('div'); play.className='playbar';
      const btn=document.createElement('button'); btn.className='btn primary'; btn.textContent='▶ Lire'; btn.addEventListener('click',()=>openPlayer(v.youtube_id,v.title)); play.appendChild(btn); a.appendChild(play);
      return a;
    }

    // Load videos
    async function loadCatalog(){
      const q=$('#q').value.trim().toLowerCase();
      let query = sb.from('videos').select('*').eq('is_hidden',false).limit(60).order('created_at',{ascending:false});
      const { data, error } = await query;
      if(error){ console.warn(error); return; }
      const trending=$('#rail-trending'); trending.innerHTML='';
      data.slice(0,10).forEach(v=>trending.appendChild(card(v)));
      const grid=$('#grid'); grid.innerHTML='';
      data.forEach(v=>grid.appendChild(card(v)));
    }

    // Player
    function openPlayer(ytId,title){
      const m=$('#playerModal'), box=$('#playerBox');
      box.innerHTML=`<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${ytId}?autoplay=1&rel=0&modestbranding=1" title="${title}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture;" allowfullscreen></iframe>`;
      m.classList.add('show');
    }
    $('#playerClose').addEventListener('click',()=>{ $('#playerModal').classList.remove('show'); $('#playerBox').innerHTML=''; });
    $('#playerModal').addEventListener('click',(e)=>{ if(e.target.id==='playerModal'){ $('#playerModal').classList.remove('show'); $('#playerBox').innerHTML=''; } });

    // Auth modal
    function openAuth(mode){
      $('#authTitle').textContent = mode==='signup'?'Créer un compte':'Connexion';
      $('#authModal').dataset.mode = mode;
      $('#authErr').textContent='';
      $('#authModal').classList.add('show');
    }
    function closeAuth(){ $('#authModal').classList.remove('show'); }
    $('#authClose').addEventListener('click',closeAuth);
    $('#btnLogin').addEventListener('click',()=>openAuth('login'));
    $('#btnSignup').addEventListener('click',()=>openAuth('signup'));

    $('#authForgot').addEventListener('click', async ()=>{
      const email = $('#authEmail').value.trim();
      if(!email){ $('#authErr').textContent='Entre ton email puis clique encore.'; return; }
      const url = location.origin + location.pathname + '#recovery';
      const { error } = await sb.auth.resetPasswordForEmail(email,{redirectTo:url});
      if(error){ $('#authErr').textContent=error.message; return; }
      $('#authErr').textContent='Email de réinitialisation envoyé.';
    });

    $('#authSubmit').addEventListener('click', async ()=>{
      const email=$('#authEmail').value.trim(), password=$('#authPass').value;
      const mode=$('#authModal').dataset.mode||'login';
      let res;
      if(mode==='signup'){
        res = await sb.auth.signUp({ email, password });
      }else{
        res = await sb.auth.signInWithPassword({ email, password });
      }
      if(res.error){ $('#authErr').textContent=res.error.message; return; }
      closeAuth();
      await afterAuth();
    });

    // Session + UI toggle
    async function afterAuth(){
      const { data:{session} } = await sb.auth.getSession();
      state.session=session;
      const logged=!!session;
      show($('#btnLogin'),!logged); show($('#btnSignup'),!logged);
      show($('#btnDashboard'),logged); show($('#btnLogout'),logged);
      show($('#dashboard'),logged);
      if(logged){ await ensureProfile(); await loadFavorites(); }
    }

    $('#btnLogout').addEventListener('click', async ()=>{
      await sb.auth.signOut(); state.session=null; state.activeProfile=null;
      show($('#btnLogin'),true); show($('#btnSignup'),true);
      show($('#btnDashboard'),false); show($('#btnLogout'),false);
      show($('#dashboard'),false);
    });

    // Profiles
    async function ensureProfile(){
      const { data:acct } = await sb.from('accounts').select('id').limit(1).maybeSingle();
      if(!acct){
        await sb.rpc('fn_init_account').catch(()=>{});
      }
      const { data:profiles } = await sb.from('profiles').select('id,name').order('created_at',{ascending:true});
      if(!profiles || profiles.length===0){
        const { data:pid } = await sb.rpc('fn_create_profile',{ profile_name:'Profil 1' });
        state.activeProfile = pid;
      } else {
        state.activeProfile = profiles[0].id;
      }
      renderProfiles();
    }

    async function renderProfiles(){
      const { data:profiles } = await sb.from('profiles').select('id,name').order('created_at',{ascending:true});
      const box=$('#profilesList'); box.innerHTML='';
      (profiles||[]).forEach(p=>{
        const row=document.createElement('div'); row.className='row'; row.style.alignItems='center';
        row.innerHTML = `
          <div class="sheet" style="flex:1;display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div><strong>${p.name}</strong> <span class="muted">${p.id===state.activeProfile?'(actif)':''}</span></div>
            <div class="row">
              <button class="btn" data-act="${p.id}">Activer</button>
              <button class="btn" data-rename="${p.id}">Renommer</button>
              <button class="btn" data-del="${p.id}">Supprimer</button>
            </div>
          </div>`;
        box.appendChild(row);
      });
    }

    // Create profile button
    $('#btnCreateProfile').addEventListener('click', async ()=>{
      const name = $('#newProfileName').value.trim() || 'Profil';
      const { error } = await sb.rpc('fn_create_profile', { profile_name: name });
      if(error){ alert(error.message); return; }
      $('#newProfileName').value='';
      await ensureProfile();
    });

    document.body.addEventListener('click', async (e)=>{
      const act=e.target.closest('[data-act]'); if(act){
        state.activeProfile = act.getAttribute('data-act'); renderProfiles(); return;
      }
      const rn=e.target.closest('[data-rename]'); if(rn){
        const id=rn.getAttribute('data-rename'); const name=prompt('Nouveau nom du profil:');
        if(!name) return;
        const { error } = await sb.from('profiles').update({ name }).eq('id', id);
        if(error) return alert(error.message);
        renderProfiles(); return;
      }
      const del=e.target.closest('[data-del]'); if(del){
        const id=del.getAttribute('data-del');
        if(!confirm('Supprimer ce profil ?')) return;
        const { error } = await sb.from('profiles').delete().eq('id', id);
        if(error) return alert(error.message);
        if(state.activeProfile===id) state.activeProfile=null;
        ensureProfile(); return;
      }
    });

    // Favorites
    async function toggleFav(v,e){
      const { data:{session} } = await sb.auth.getSession();
      if(!session){ openAuth('login'); return; }
      if(!state.activeProfile){ await ensureProfile(); }
      const { data:exists } = await sb.from('favorites').select('video_id').eq('profile_id', state.activeProfile).eq('video_id', v.id).maybeSingle();
      if(exists){
        await sb.from('favorites').delete().eq('profile_id', state.activeProfile).eq('video_id', v.id);
      }else{
        await sb.from('favorites').insert({ profile_id: state.activeProfile, video_id: v.id });
      }
      loadFavorites();
    }

    async function loadFavorites(){
      if(!state.activeProfile){ $('#favGrid').innerHTML=''; show($('#favEmpty'),true); return; }
      const { data, error } = await sb.from('favorites').select('video_id, videos(*)').eq('profile_id', state.activeProfile).order('created_at',{ascending:false});
      if(error){ console.warn(error); return; }
      const grid=$('#favGrid'); grid.innerHTML='';
      (data||[]).forEach(row=> grid.appendChild(card(row.videos)));
      show($('#favEmpty'), (data||[]).length===0 );
    }

    // Account: change email/pass
    $('#btnChangeEmail').addEventListener('click', async ()=>{
      const newEmail=$('#newEmail').value.trim(); if(!newEmail) return alert('Email requis');
      const { error } = await sb.auth.updateUser({ email: newEmail });
      if(error) return alert(error.message);
      alert('Email mis à jour. Vérifie ta boîte si confirmation requise.');
    });
    $('#btnChangePass').addEventListener('click', async ()=>{
      const a=$('#newPass').value, b=$('#newPass2').value;
      if(!a||!b) return alert('Mot de passe requis');
      if(a!==b) return alert('Les mots de passe ne correspondent pas');
      const { error } = await sb.auth.updateUser({ password: a });
      if(error) return alert(error.message);
      alert('Mot de passe mis à jour');
    });

    // Tabs dashboard
    $$('.tab').forEach(t=>t.addEventListener('click',()=>{
      $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
      ['fav','profiles','account'].forEach(id=> show($('#tab-'+id), id===t.dataset.tab) );
    }));

    // Search
    $('#q').addEventListener('input',()=>{ loadCatalog(); });

    // Recovery route
    if(location.hash==='#recovery'){
      openAuth('login');
      $('#authTitle').textContent='Réinitialiser le mot de passe';
    }

    // Init
    $('#year').textContent=new Date().getFullYear();
    loadCatalog();
    afterAuth();
  </script>
</body>
</html>
